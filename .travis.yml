language: go

# Use latest 2-3 Go versions and uncomment all arch when preparing to release. It's too slow to have all combos enabled.
go:
  - 1.13.x
  - 1.12.x

arch:
  - amd64
#  - arm64
#  - ppc64le
#  - s390x

os:
  - linux  

env:
  - GO111MODULE=on

# This script is run on all arch. Go doesn't support -race on s390x.
script:
  - go build ./...
  - go test -short ./... -v

# These jobs are run only on linux_amd64 using first version of Go listed above.
# Tinylint shouldn't be allowed to fail, while Biglint can be allowed to fail.
# TODO: Remove allow_failures for Tinylint after it succeeds.
jobs:
  fast_finish: true
  allow_failures:
  - script: golangci-lint run --disable-all --timeout=3m -E errcheck -E gofmt -E golint -E govet -E ineffassign -E staticcheck -E typecheck -E unconvert
  - script: golangci-lint run --timeout=5m
  include:
    - os: linux
      arch: amd64
    - name: "RaceAndCover"
      script:
      - go test -short -race ./... -v
      - go test -short -coverprofile=coverage.txt -covermode=atomic ./...
      after_success: bash <(curl -s https://codecov.io/bash)      
    - name: "Tinylint"
      install: curl -sfL https://install.goreleaser.com/github.com/golangci/golangci-lint.sh | sh -s -- -b $(go env GOPATH)/bin v1.23.1
      script: golangci-lint run --disable-all --timeout=3m -E errcheck -E gofmt -E golint -E govet -E ineffassign -E staticcheck -E typecheck -E unconvert
    - name: "Biglint"
      install: curl -sfL https://install.goreleaser.com/github.com/golangci/golangci-lint.sh | sh -s -- -b $(go env GOPATH)/bin v1.23.1
      script: golangci-lint run --timeout=5m
